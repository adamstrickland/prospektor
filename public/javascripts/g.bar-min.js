/*
 * g.Raphael 0.3 - Charting library, based on RaphaÃ«l (http://raphaeljs.com)
 *
 * Copyright (c) 2009 Dmitry Baranovskiy (http://g.raphaeljs.com)
 * Licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) license.
 */
Raphael.fn.g.barchart=function(b,Z,A,D,r,W,Q){Q=Q||{};var t={round:"round",sharp:"sharp",soft:"soft"}[Q.type]||"square",K=parseFloat(Q.gutter||"20%"),p=this.set(),S=this.set(),E=this.set(),O=this.set(),T=Math.max.apply(Math,r),q=[],C=this,a=0,f=Q.colors||this.g.colors,N=r.length;if(this.raphael.isArray(r[0])){T=[];a=N;N=0;for(var n=r.length;n--;){T.push(Math.max.apply(Math,r[n]));N=Math.max(N,r[n].length);}if(Q.stacked){for(var n=N;n--;){var I=0;for(var m=r.length;m--;){I+=+r[m][n]||0;}q.push(I);}}for(var n=r.length;n--;){if(r[n].length<N){for(var m=N;m--;){r[n].push(0);}}}T=Math.max.apply(Math,Q.stacked?q:T);}T=(Q.to)||T;if(!W){var c=A/(N*(100+K)+K)*100,B=c*K/100,G=typeof Q.vgutter=="undefined"?20:Q.vgutter,P=[],H=b+B,F=(D-2*G)/T;if(!Q.stretch){B=Math.round(B);c=Math.floor(c);}!Q.stacked&&(c/=a||1);for(var n=0;n<N;n++){P=[];for(var m=0;m<a;m++){var o=Math.round((a?r[m][n]:r[n])*F),J=Z+D-G-o,k;S.push(k=this.g.finger(Math.round(H+c/2),J+o,c,Q.init?0:o,true,t).attr({stroke:"none",fill:f[a?m:n]}));k.y=J;k.x=Math.round(H+c/2);k.w=c;k.h=o;k.value=a?r[m][n]:r[n];Q.init&&k.animate({path:this.g.finger(Math.round(H+c/2),J+o,c,o,true,t,1)},(+Q.init-1)||1000,">");if(!Q.stacked){H+=c;}else{P.push(k);}}if(Q.stacked){var l;O.push(l=this.rect(P[0].x-P[0].w/2,Z,c,D).attr({stroke:"none",fill:"#000",opacity:0}));l.bars=[];for(var e=0,M=P.length;e<M;e++){l.bars.push(P[e]);}P.sort(function(Y,X){return Y.value-X.value;});var L=0;for(var e=P.length;e--;){P[e].toFront();}for(var e=0,M=P.length;e<M;e++){var k=P[e],U,o=(L+k.value)*F,g=this.g.finger(k.x,Z+D-G-!!L*0.5,c,o,true,t,1);L&&Q.init&&k.animate({path:g},(+Q.init-1)||1000,">");L&&!Q.init&&k.attr({path:g});k.h=o;k.y=Z+D-G-!!L*0.5-o;E.push(U=this.rect(k.x-k.w/2,k.y,c,k.value*F).attr({stroke:"none",fill:"#000",opacity:0}));U.bar=k;L+=k.value;}H+=c;}H+=B;}O.toFront();H=b+B;if(!Q.stacked){for(var n=0;n<N;n++){for(var m=0;m<a;m++){var U;E.push(U=this.rect(Math.round(H),Z+G,c,D-G).attr({stroke:"none",fill:"#000",opacity:0}));U.bar=S[n*(a||1)+m];H+=c;}H+=B;}}p.label=function(s,w){s=s||[];this.labels=C.set();var x,X=-Infinity;if(Q.stacked){for(var h=0;h<N;h++){var u=0;for(var Y=0;Y<a;Y++){u+=a?r[Y][h]:r[h];if(Y==a-1){var y=C.g.labelise(s[h],u,T);x=C.g.text(S[h*(a||1)+Y].x,Z+D-G/2,y).insertBefore(E[h*(a||1)+Y]);var v=x.getBBox();if(v.x-7<X){x.remove();}else{this.labels.push(x);X=v.x+v.width;}}}}}else{for(var h=0;h<N;h++){for(var Y=0;Y<a;Y++){var y=C.g.labelise(a?s[Y]&&s[Y][h]:s[h],a?r[Y][h]:r[h],T);x=C.g.text(S[h*(a||1)+Y].x,w?Z+D-G/2:S[h*(a||1)+Y].y-10,y).insertBefore(E[h*(a||1)+Y]);var v=x.getBBox();if(v.x-7<X){x.remove();}else{this.labels.push(x);X=v.x+v.width;}}}}return this;};}else{var V=Math.floor(D/(N*(100+K)+K)*100),d=Math.floor(V*K/100),P=[],F=Z+d,H=(A-1)/T;!Q.stacked&&(V/=a||1);for(var n=0;n<N;n++){P=[];for(var m=0;m<a;m++){var R=a?r[m][n]:r[n],k;S.push(k=this.g.finger(b,F+V/2,Q.init?0:Math.round(R*H),V-1,false,t).attr({stroke:f[a>1?m:n],fill:f[a>1?m:n]}));k.x=b+Math.round(R*H);k.y=F+V/2;k.w=Math.round(R*H);k.h=V;k.value=+R;Q.init&&k.animate({path:this.g.finger(b,F+V/2,Math.round(R*H),V-1,false,t,1)},(+Q.init-1)||500,">");if(!Q.stacked){F+=V;}else{P.push(k);}}if(Q.stacked){P.sort(function(Y,X){return Y.value-X.value;});var L=0;for(var e=P.length;e--;){P[e].toFront();}for(var e=0,M=P.length;e<M;e++){var k=P[e],U,R=Math.round((L+k.value)*H),g=this.g.finger(b,k.y,R,V-1,false,t,1);L&&Q.init&&k.animate({path:g},(+Q.init-1)||1000,">");L&&!Q.init&&k.attr({path:g});k.w=R;k.x=b+R;E.push(U=this.rect(b+L*H,k.y-k.h/2,k.value*H,V).attr({stroke:"none",fill:"#000",opacity:0}));U.bar=k;L+=k.value;}F+=V;}F+=d;}F=Z+d;if(!Q.stacked){for(var n=0;n<N;n++){for(var m=0;m<a;m++){E.push(this.rect(b,F,A,V).attr({stroke:"none",fill:"#000",opacity:0}));F+=V;}F+=d;}}p.label=function(y,w){y=y||[];this.labels=C.set();for(var v=0;v<N;v++){for(var u=0;u<a;u++){var s=C.g.labelise(a?y[u]&&y[u][v]:y[v],a?r[u][v]:r[v],T);var x=w?S[v*(a||1)+u].x-V/2+3:b+5,h=w?"end":"start",Y;this.labels.push(Y=C.g.text(x,S[v*(a||1)+u].y,s).attr({"text-anchor":h}).insertBefore(E[0]));if(Y.getBBox().x<b+5){Y.attr({x:b+5,"text-anchor":"start"});}else{S[v*(a||1)+u].label=Y;}}}return this;};}p.hover=function(Y,X){O.hide();E.show();X=X||function(){};E.mouseover(Y).mouseout(X);return this;};p.hoverColumn=function(Y,X){E.hide();O.show();X=X||function(){};O.mouseover(Y).mouseout(X);return this;};p.click=function(X){O.hide();E.show();E.click(X);return this;};p.clickColumn=function(X){E.hide();O.show();O.click(X);return this;};p.push(S,E,O);p.bars=S;p.covers=E;return p;};